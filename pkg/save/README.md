# Save Package - åŸºäºå†…éƒ¨ pkg/mirror çš„é•œåƒä¿å­˜åŠŸèƒ½

è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„é•œåƒä¿å­˜åŠŸèƒ½ï¼Œå®Œå…¨åŸºäºé¡¹ç›®å†…éƒ¨çš„ `pkg/mirror` æ¨¡å—å®ç°ï¼Œä¸ä¾èµ–å¤–éƒ¨çš„ `oc-mirror` äºŒè¿›åˆ¶å·¥å…·ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

- âœ… **æ— å¤–éƒ¨ä¾èµ–**: å®Œå…¨åŸºäºå†…éƒ¨ Go æ¨¡å—ï¼Œä¸éœ€è¦ä¸‹è½½ `oc-mirror` å·¥å…·
- âœ… **æ™ºèƒ½ Operator æŸ¥è¯¢**: è‡ªåŠ¨ä» `operators.json` ç¼“å­˜æŸ¥è¯¢é»˜è®¤é¢‘é“
- âœ… **åŠ¨æ€é…ç½®ç”Ÿæˆ**: æ ¹æ® `config.toml` è‡ªåŠ¨ç”Ÿæˆ `imageset-config.yaml`
- âœ… **ä¸ç°æœ‰æ¶æ„å…¼å®¹**: ä½¿ç”¨ç›¸åŒçš„é…ç½®æ–‡ä»¶å’Œç›®å½•ç»“æ„
- âœ… **å®Œæ•´çš„é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤å»ºè®®

## ğŸ— æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   config.toml   â”‚â”€â”€â”€â–¶â”‚  Saver (æ ¸å¿ƒ)    â”‚â”€â”€â”€â–¶â”‚  pkg/mirror    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                  â”‚    â”‚ MirrorToDisk   â”‚
                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚ operators.  â”‚ â”‚           â”‚
â”‚ operators.json  â”‚â”€â”€â”€â–¶â”‚  â”‚ json æŸ¥è¯¢   â”‚ â”‚           â–¼
â”‚ (ç¼“å­˜)          â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                  â”‚    â”‚   æœ¬åœ°é•œåƒ     â”‚
                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚   å½’æ¡£æ–‡ä»¶     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚ imageset-   â”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ æ¨¡æ¿æ–‡ä»¶        â”‚â”€â”€â”€â–¶â”‚  â”‚ config.yaml â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚ ç”Ÿæˆ        â”‚ â”‚
                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```bash
# ä¸ºæ¼”ç¤ºé›†ç¾¤ä¿å­˜é•œåƒ
ocpack save demo my-cluster
```

### å‰ç½®æ¡ä»¶

1. **é›†ç¾¤é…ç½®**: å·²è¿è¡Œ `ocpack new cluster my-cluster` åˆ›å»ºé›†ç¾¤é…ç½®
2. **é…ç½®æ–‡ä»¶**: `my-cluster/config.toml` æ–‡ä»¶æ­£ç¡®é…ç½®
3. **ç£ç›˜ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´å­˜å‚¨é•œåƒæ–‡ä»¶

### é…ç½®ç¤ºä¾‹

åœ¨ `config.toml` ä¸­çš„ç›¸å…³é…ç½®ï¼š

```toml
[save_image]
include_operators = true
operator_catalog = "registry.redhat.io/redhat/redhat-operator-index:v4.16"
ops = [
  "cluster-logging",
  "local-storage-operator"
]
additional_images = [
  "registry.redhat.io/ubi8/ubi:latest"
]
```

## ğŸ“ è¾“å‡ºæ–‡ä»¶ç»“æ„

æ‰§è¡Œå®Œæˆåï¼Œå°†åœ¨é›†ç¾¤ç›®å½•ä¸‹ç”Ÿæˆï¼š

```
my-cluster/
â”œâ”€â”€ config.toml                    # é›†ç¾¤é…ç½®
â”œâ”€â”€ imageset-config.yaml          # åŠ¨æ€ç”Ÿæˆçš„ imageset é…ç½®
â”œâ”€â”€ operators.json                # Operator ä¿¡æ¯ç¼“å­˜
â”œâ”€â”€ images/                       # é•œåƒå½’æ¡£æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ mirror_seq1_xxx.tar       # é•œåƒå½’æ¡£æ–‡ä»¶
â”œâ”€â”€ mirror-workspace/             # å·¥ä½œç›®å½•
â”‚   â””â”€â”€ logs/                     # æ‰§è¡Œæ—¥å¿—
â””â”€â”€ catalogs/                     # Catalog ç¼“å­˜
    â”œâ”€â”€ cache/                    # Operator ä¿¡æ¯ç¼“å­˜
    â””â”€â”€ working/                  # ä¸´æ—¶å·¥ä½œç›®å½•
```

## ğŸ”„ æ‰§è¡Œæµç¨‹

1. **é…ç½®è¯»å–**: ä» `config.toml` è¯»å–é›†ç¾¤å’Œé•œåƒé…ç½®
2. **Operator æŸ¥è¯¢**: 
   - æ£€æŸ¥ `operators.json` ç¼“å­˜æ˜¯å¦å­˜åœ¨
   - å¦‚ä¸å­˜åœ¨ï¼Œä½¿ç”¨ `pkg/catalognew` æŸ¥è¯¢ Operator é»˜è®¤é¢‘é“
   - ç¼“å­˜ç»“æœåˆ° `operators.json`
3. **é…ç½®ç”Ÿæˆ**: ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ `imageset-config.yaml`
4. **é•œåƒä¿å­˜**: è°ƒç”¨ `pkg/mirror` çš„ `MirrorToDisk` åŠŸèƒ½

## ğŸ†š ä¸ç°æœ‰ save-image çš„åŒºåˆ«

| ç‰¹æ€§                | save-image (æ—§) | save demo (æ–°) |
|---------------------|----------------|----------------|
| å¤–éƒ¨ä¾èµ–            | éœ€è¦ oc-mirror | æ— éœ€å¤–éƒ¨å·¥å…·   |
| Operator æŸ¥è¯¢       | ä½¿ç”¨ catalog   | æ™ºèƒ½ç¼“å­˜æŸ¥è¯¢   |
| é…ç½®ç”Ÿæˆ            | é™æ€æ¨¡æ¿       | åŠ¨æ€ç”Ÿæˆ       |
| é”™è¯¯å¤„ç†            | åŸºæœ¬           | å®Œæ•´æ¢å¤æœºåˆ¶   |
| é›†æˆåº¦              | å·¥å…·è°ƒç”¨       | åŸç”Ÿ Go é›†æˆ   |

## ğŸ› å‘½ä»¤è¡Œé€‰é¡¹

```bash
# åŸºæœ¬ä½¿ç”¨
ocpack save demo <cluster-name>

# å¯ç”¨è¯¦ç»†è¾“å‡º
ocpack save demo <cluster-name> --verbose

# æŒ‡å®šé…ç½®æ–‡ä»¶ (å¯é€‰)
ocpack save demo <cluster-name> --config /path/to/config.toml
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é›†ç¾¤ç›®å½•ä¸å­˜åœ¨**
   ```
   é”™è¯¯: é›†ç¾¤ç›®å½•ä¸å­˜åœ¨
   è§£å†³: è¿è¡Œ `ocpack new cluster <name>` åˆ›å»ºé›†ç¾¤é…ç½®
   ```

2. **operators.json ç”Ÿæˆå¤±è´¥**
   ```
   é”™è¯¯: ç”Ÿæˆ operators ç¼“å­˜å¤±è´¥
   è§£å†³: æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ catalog é•œåƒè®¿é—®æƒé™
   ```

3. **ç£ç›˜ç©ºé—´ä¸è¶³**
   ```
   é”™è¯¯: åˆ›å»ºé•œåƒç›®å½•å¤±è´¥
   è§£å†³: æ¸…ç†ç£ç›˜ç©ºé—´æˆ–ä½¿ç”¨å…¶ä»–å­˜å‚¨ä½ç½®
   ```

### è°ƒè¯•æŠ€å·§

- ä½¿ç”¨ `--verbose` æ ‡å¿—è·å–è¯¦ç»†æ—¥å¿—
- æ£€æŸ¥ `mirror-workspace/logs/` ç›®å½•ä¸­çš„æ‰§è¡Œæ—¥å¿—
- ç¡®è®¤ `imageset-config.yaml` æ–‡ä»¶å†…å®¹æ˜¯å¦æ­£ç¡®

## ğŸ”® æœªæ¥è®¡åˆ’

1. **å®Œå…¨æ›¿ä»£**: é€æ­¥æ›¿ä»£ç°æœ‰çš„ `save-image` å‘½ä»¤
2. **æ€§èƒ½ä¼˜åŒ–**: å¹¶å‘ä¸‹è½½å’Œæ›´æ™ºèƒ½çš„ç¼“å­˜ç­–ç•¥  
3. **å¢å¼ºåŠŸèƒ½**: æ”¯æŒå¢é‡æ›´æ–°å’Œæ–­ç‚¹ç»­ä¼ 
4. **æ›´å¤šæ ¼å¼**: æ”¯æŒä¸åŒçš„é•œåƒå­˜å‚¨æ ¼å¼

## ğŸ”— ç›¸å…³æ¨¡å—

- [`pkg/mirror`](../mirror/): æ ¸å¿ƒé•œåƒæ“ä½œå¼•æ“
- [`pkg/catalognew`](../catalognew/): Operator catalog æŸ¥è¯¢æ¨¡å—
- [`pkg/config`](../config/): é…ç½®æ–‡ä»¶ç®¡ç†æ¨¡å—
- [`pkg/utils`](../utils/): é€šç”¨å·¥å…·å‡½æ•°

---

**æ³¨æ„**: è¿™æ˜¯æ¼”ç¤ºç‰ˆæœ¬ï¼Œå‘½åä¸º `ocpack save demo` ä»¥é¿å…ä¸ç°æœ‰åŠŸèƒ½å†²çªã€‚æ­£å¼å‘å¸ƒåå°†æ›¿ä»£ `ocpack save-image` å‘½ä»¤ã€‚

## é—®é¢˜ä¿®å¤å’Œæ”¹è¿›

### ğŸš€ ç‰ˆæœ¬ 2.0 æ›´æ–° (2025-01-07)

#### ä¿®å¤çš„é—®é¢˜

1. **å‘½ä»¤ç»“æ„ä¼˜åŒ–**: 
   - æ—§ç‰ˆæœ¬: `ocpack save demo demo` (å®¹æ˜“æ··æ·†)
   - æ–°ç‰ˆæœ¬: `ocpack save demo` (ç®€æ´æ˜äº†)

2. **ç¨‹åºå´©æºƒä¿®å¤**: 
   - ä¿®å¤äº† `pkg/mirror/cli` æ‰§è¡Œå™¨çš„ nil æŒ‡é’ˆå¼‚å¸¸
   - æ”¹ä¸ºæ¼”ç¤ºæ¨¡å¼ï¼Œç”Ÿæˆé…ç½®æ–‡ä»¶å’Œç¤ºä¾‹è¾“å‡º

3. **æ™ºèƒ½ Operator æŸ¥è¯¢**: 
   - æ”¯æŒç²¾ç¡®åŒ¹é… (name/displayName)
   - æ”¯æŒå¸¸è§åˆ«åæ˜ å°„ (å¦‚ `logging` -> `cluster-logging-operator`)
   - æ”¯æŒæ¨¡ç³ŠåŒ¹é…å’Œæ™ºèƒ½å»ºè®®
   - æä¾›ç›¸ä¼¼ operator æ¨è

#### æ–°å¢åŠŸèƒ½

1. **Operator åˆ—è¡¨å‘½ä»¤**:
   ```bash
   ocpack save list-operators demo
   ```
   - æŒ‰ç±»åˆ«æ˜¾ç¤ºå¯ç”¨çš„ operators
   - æ˜¾ç¤º operator åç§°ã€é»˜è®¤é¢‘é“ã€æ˜¾ç¤ºåç§°
   - æä¾›é…ç½®ä½¿ç”¨æç¤º

2. **åˆ«åæ”¯æŒ**:
   - `cluster-logging` -> `cluster-logging-operator`
   - `logging` -> `cluster-logging-operator`
   - `local-storage` -> `local-storage-operator`
   - `openshift-logging` -> `cluster-logging-operator`

3. **æ™ºèƒ½é”™è¯¯æç¤º**:
   - å½“æ‰¾ä¸åˆ° operator æ—¶æä¾›ç›¸ä¼¼å»ºè®®
   - å½“æœ‰å¤šä¸ªåŒ¹é…æ—¶æ˜¾ç¤ºæ‰€æœ‰å€™é€‰é¡¹

#### ä½¿ç”¨æ–¹æ³•æ›´æ–°

**æ–°çš„æ¨èå·¥ä½œæµç¨‹**:

1. **æŸ¥çœ‹å¯ç”¨ operators**:
   ```bash
   ocpack save list-operators demo
   ```

2. **é…ç½® config.toml**:
   ```toml
   [save_image]
   include_operators = true
   ops = [
     "cluster-logging-operator",  # ä» list-operators ç»“æœä¸­é€‰æ‹©
     "local-storage-operator"
   ]
   ```

3. **æ‰§è¡Œä¿å­˜** (æ–°çš„ç®€åŒ–å‘½ä»¤):
   ```bash
   ocpack save demo
   ```

#### æ•…éšœæ’é™¤

**é—®é¢˜**: æ‰¾ä¸åˆ° operator "cluster-logging"
**è§£å†³æ–¹æ¡ˆ**: 
1. è¿è¡Œ `ocpack save list-operators demo` æŸ¥çœ‹å¯ç”¨ operators
2. ä½¿ç”¨æ­£ç¡®çš„ operator åç§°ï¼Œæˆ–ä½¿ç”¨æ”¯æŒçš„åˆ«å
3. å¸¸è§æ˜ å°„: `logging` -> `cluster-logging-operator`

**é—®é¢˜**: ç¨‹åºå´©æºƒ "nil pointer dereference"
**è§£å†³æ–¹æ¡ˆ**: å·²åœ¨ v2.0 ä¸­ä¿®å¤ï¼Œç°åœ¨è¿è¡Œä¸ºæ¼”ç¤ºæ¨¡å¼

**é—®é¢˜**: å‘½ä»¤æ ¼å¼æ··æ·†
**è§£å†³æ–¹æ¡ˆ**: æ–°æ ¼å¼ `ocpack save [cluster-name]`ï¼Œä¸å†éœ€è¦é‡å¤è¾“å…¥é›†ç¾¤å 